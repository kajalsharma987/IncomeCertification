<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Official Certificate - Fixed</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
      body {
        background: #777;
        margin: 0;
        padding: 20px;
        font-family: "Times New Roman", Times, serif;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .no-print {
        background: #fff;
        padding: 10px;
        margin-bottom: 20px;
        width: 210mm;
        display: flex;
        justify-content: center;
        border-radius: 4px;
      }
      #certificate {
        width: 210mm;
        height: 297mm;
        max-height: 297mm;
        background: white;
        padding: 10mm 12mm;
        box-sizing: border-box;
        position: relative;
        color: #000;
        border: 2px solid #000;
        overflow: hidden;
      }
      .header-wrap {
        display: flex;
        border-bottom: 1px solid #000;
        padding-bottom: 4px;
        margin-bottom: 8px;
      }
      .header-content {
        flex-grow: 1;
        text-align: center;
        padding-right: 45px;
      }
      .header-content p {
        margin: 0;
        font-size: 14px;
        font-weight: bold;
      }
      .header-content h2 {
        margin: 1px 0;
        font-size: 19px;
        letter-spacing: 0.3px;
      }

      .meta-container {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
        font-size: 13.5px;
      }
      /* Barcode fix for PDF */
      .barcode-box {
        margin-top: 5px;
        width: 160px;
      }
      .barcode-svg {
        width: 160px;
        height: 35px;
        border: 0.5px solid #000;
      }
      .barcode-img {
        width: 120px; /* barcode ki width */
        height: 30px; /* barcode ki height */
        display: block;
        margin-top: 2px;
      }

      .barcode-number {
        display: block;
        width: 160px; /* SAME as barcode */
        text-align: left;
        letter-spacing: 1.5px;
        /* text: bold; */
        font-size: 12.5px;
        /* letter-spacing: 2px; */
        margin-top: 2px;
      }

      .app-side {
        text-align: right;
        line-height: 1.3;
        font-size: 13.5px;
      }
      .app-side div {
        margin-bottom: 5px;
      }

      .title-block {
        text-align: center;
        margin: 25px 0;
      }
      .title-block h1 {
        font-size: 16px;
        text-decoration: underline;
        font-weight: bold;
      }

      .middle-section {
        font-size: 14.5px;
        line-height: 1.9;
        margin-top: 5px;
      }
      .row {
        display: flex;
        align-items: baseline;
        margin-bottom: 6px;
      }
      .editable {
        outline: none;
        font-weight: bold;
        text-transform: uppercase;
        cursor: text;
        padding: 0 3px;
      }
      .eng-para {
        margin-top: 25px;
        text-align: justify;
        line-height: 1.7;
        font-size: 14px;
      }

      /* Pure footer area ko manage karne ke liye */
      .footer-wrap {
        display: flex;
        justify-content: space-between; /* QR ko left aur Signature ko right bhejne ke liye */
        align-items: flex-end; /* Dono ko bottom se align rakhega */
        font-family: Arial, sans-serif;
        padding: 20px;
        width: 100%;
      }
      .footer-block {
        position: static;
      }

      #qr-box {
        width: 100px; /* QR code ka size yahan adjust karein */
        height: 100px;
        background-color: #eee; /* Sirf placeholder ke liye */
        position: relative;
        overflow: hidden;
      }
      .qr-cross {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
      }
      .qr-cross::before,
      .qr-cross::after {
        content: "";
        position: absolute;
        background: #000;
      }
      .qr-cross::before {
        width: 100%;
        height: 3px;
        top: 50%;
        left: 0;
        margin-top: -1.5px;
      }
      .qr-cross::after {
        width: 3px;
        height: 100%;
        top: 0;
        left: 50%;
        margin-left: -1.5px;
      }

      .sig-section {
        text-align: left; /* Text khud left-aligned rahega lekin box right mein hoga */
      }

      .sig-auth-title {
        font-size: 11px;
        display: block;
        margin-bottom: 6px;
      }

      .sig-container {
        display: flex;
        align-items: flex-start;
      }

      .sig-valid-text {
        font-size: 10.5px;
        /* font-weight: bold; */
        display: block;
      }

      .sig-details {
        font-size: 7px;
        line-height: 1.15;
      }

      .green-tick {
        height: 42px;
        margin-left: -5px; /* Tick ko details ke sath overlap karne ke liye */
        margin-top: 3px;
      }

      .notes-area {
        margin-top: 30px;
        /* Line removed as requested */
        padding-top: 2px;
      }
      .csc-footer {
        position: absolute;
        bottom: 12mm;
        width: 80%;
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        font-style: italic;
      }

      @media print {
        .no-print {
          display: none;
        }
        body {
          background: #fff;
          padding: 0;
        }
      }
      @page {
        size: A4;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="no-print">
      <button
        onclick="savePDF()"
        style="
          padding: 10px 20px;
          background: #000;
          color: #fff;
          border: none;
          cursor: pointer;
          font-weight: bold;
        "
      >
        DOWNLOAD FINAL PDF
      </button>
    </div>

    <div id="certificate">
      <div class="header-wrap">
        <div style="width: 70px">
          <img
            src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/55/Emblem_of_India.svg/800px-Emblem_of_India.svg.png"
            style="width: 60px"
            crossorigin="anonymous"
          />
        </div>
        <div class="header-content">
          <p>অসম চৰকাৰ</p>
          <h2>GOVERNMENT OF ASSAM</h2>
          <p>চক্ৰ বিষয়া কাৰ্যালয়</p>
          <p>
            OFFICE OF THE CIRCLE OFFICER<br />
            <span class="editable" contenteditable="true">TINSUKIA</span>
          </p>
          <!-- <br /> -->
          <p>
            <span class="editable" data-field="district" contenteditable="true"
              >TINSUKIA DISTRICT</span
            >
          </p>
          <!-- <br/> -->
          <p>(Assam e-District Project)</p>
        </div>
      </div>

      <div class="meta-container">
        <div class="barcode-side">
          প্ৰমাণ পত্ৰ নং <br />
          Certificate No. :
          <span class="editable" id="certNo" contenteditable="true"
            >12122025-001-15682285</span
          ><br /><br />

          <div class="barcode-box">
            <svg id="barcodeSvg" class="barcode-svg"></svg>
          </div>

          <span
            class="editable barcode-number"
            id="certNoBarcode"
            contenteditable="true"
          >
            1212202500115682285
          </span>
        </div>
        <div class="app-side">
          <div>আবেদন নং</div>
          <div>
            Application No. :
            <span class="editable" id="appNo" contenteditable="true">
              SSDG/ED/INC/109435568
            </span>
          </div>
          <div>
            তাৰিখ / Date:
            <span class="editable" id="issueDate" contenteditable="true"
              >12-12-2025</span
            >
          </div>
        </div>
      </div>

      <div class="title-block">
        <p style="font-size: 12.5px; margin: 0">বার্ষিক আয়ৰ প্ৰমাণ পত্ৰ</p>
        <h1>ANNUAL INCOME CERTIFICATE</h1>
      </div>

      <div class="middle-section">
        <div class="row">
          <span>ইয়াৰ দ্বাৰা প্ৰমাণ পত্ৰ দিয়া হ'ল যে</span>
          <div style="flex-grow: 1; text-align: center">
            <span
              class="editable"
              id="personName"
              data-field="name"
              contenteditable="true"
              >PAVAN KUMAR</span
            >
          </div>
          <span>ব পুত্ৰ / কন্যা / পত্নী / স্বামী</span>
        </div>
        <div class="row">
          <div style="width: 320px; text-align: center">
            <span
              class="editable"
              id="fatherName"
              data-field="father"
              contenteditable="true"
              >SUKHVIR SINGH</span
            >
          </div>
          <span>গাঁও/ নগৰ:</span>
          <div style="flex-grow: 1; text-align: center">
            <span
              class="editable"
              id="village"
              data-field="village"
              contenteditable="true"
              >NOWSALIA GAON</span
            >
          </div>
        </div>
        <div class="row" style="justify-content: space-between">
          <div>
            মৌজা :
            <span
              class="editable"
              id="mouza"
              data-field="mouza"
              contenteditable="true"
              >RONGAGORA</span
            >
          </div>
          <div>
            চক্ৰ :
            <span
              class="editable"
              id="circle"
              data-field="circle"
              contenteditable="true"
              >TINSUKIA</span
            >
          </div>
          <div>
            জিলা :
            <span
              class="editable"
              id="district"
              data-field="district"
              contenteditable="true"
              >JORHAT</span
            >
          </div>
        </div>
        <div class="row">
          <span>মুঠ বার্ষিক আয়</span>
          <div style="flex-grow: 1; text-align: center">
            <span
              class="editable"
              id="incomeSource"
              data-field="income"
              contenteditable="true"
              >CULTIVATION</span
            >
          </div>
          <span
            >ৰ পৰা Rs.
            <span
              class="editable"
              id="amount"
              data-field="amount"
              contenteditable="true"
              >3,00,000</span
            ></span
          >
        </div>
        <div class="row">
          <span
            >(Rupees
            <span
              class="editable"
              id="amountWords"
              data-field="words"
              contenteditable="true"
              >Three Lakh</span
            >
            ) only</span
          >
          <div style="flex-grow: 1; text-align: right">টকা হয়।</div>
        </div>

        <div class="eng-para">
          This is to certify that
          <b
            ><span class="editable" data-field="name" contenteditable="true"
              >PAVAN KUMAR</span
            ></b
          >
          son/ daughter/ wife/ husband of
          <b
            ><span class="editable" data-field="father" contenteditable="true"
              >SUKHVIR SINGH</span
            ></b
          >
          Village / Town
          <b
            ><span class="editable" data-field="village" contenteditable="true"
              >NOWSALIA GAON</span
            ></b
          >
          Mouza
          <b
            ><span class="editable" data-field="mouza" contenteditable="true"
              >RONGAGORA</span
            ></b
          >
          Circle
          <b
            ><span class="editable" data-field="circle" contenteditable="true"
              >TINSUKIA</span
            ></b
          >
          District
          <b
            ><span class="editable" data-field="district" contenteditable="true"
              >JORHAT</span
            ></b
          >
          whose total annual income from
          <b
            ><span class="editable" data-field="income" contenteditable="true"
              >CULTIVATION</span
            ></b
          >
          is Rs.
          <b
            ><span class="editable" data-field="amount" contenteditable="true"
              >3,00,000</span
            ></b
          >
          (Rupees
          <b
            ><span class="editable" data-field="words" contenteditable="true"
              >Three Lakh</span
            ></b
          >) only.
        </div>
        <div style="margin-top: 18px; font-size: 12.5px; line-height: 1.5">
          এই প্ৰমাণ পত্ৰ সংশ্লিষ্ট এল এমৰ প্ৰতিবেদন ভিত্তিত প্ৰদান কৰা হ'ল /
          This certificate is issued on the basis of concerned L.M's report.

          <br /><br />

          This certificate is valid for one year from the date of issue
        </div>
      </div>
      <div class="footer-block">
        <div class="footer-wrap">
          <div id="qr-box">
            <!-- <img src="qr_code_image.png" alt="QR Code" style="width: 100%" /> -->
          </div>

          <div class="sig-section">
            <span class="sig-auth-title">Signature of Approving Authority</span>

            <div class="sig-container">
              <div class="text-side">
                <span class="sig-valid-text">Signature valid</span>
                <div class="sig-details">
                  Digitally Signed.<br />
                  Name:
                  <span class="editable" contenteditable="true"
                    >KRITIKA SARMAH</span
                  ><br />
                  Date:
                  <span class="editable" contenteditable="true"
                    >12-Dec-2025 12:41:45</span
                  ><br />
                  Reason: eDistrict<br />
                  Location: Assam
                </div>
              </div>
              <img src="GreenTick.png" class="green-tick" alt="Valid" />
            </div>
          </div>
        </div>

        <div class="notes-area">
          <span
            style="
              font-weight: bold;
              text-decoration: underline;
              font-size: 11px;
            "
            >NOTE :</span
          >
          <ol
            style="
              font-size: 10.5px;
              font-style: italic;
              line-height: 1.4;
              margin: 5px 0 0 15px;
              padding: 0;
            "
          >
            <li>
              This certificate is digitally signed and therefore needs no
              physical signature.
            </li>
            <li>
              Authenticity can be verified from
              http://www.assam.gov.in/certificate-verification.
            </li>
            <li>
              This certificate is legally valid as per the Information
              Technology Act 2000.
            </li>
            <li>Tampering of this certificate will attract penal action.</li>
          </ol>
        </div>

        <div class="csc-footer">
          <div>
            CSC Name :
            <span
              class="editable"
              id="cscName"
              data-field="cscName"
              contenteditable="true"
              >Tinsukia,SRIPURIA TINGRAI</span
            >
          </div>
          <div>
            CSC ID :
            <span
              class="editable"
              id="cscId"
              data-field="cscId"
              contenteditable="true"
              >AS247123630012</span
            >
          </div>
        </div>
      </div>
    </div>
    <script>
      function generateQR() {
        const authURL = new URL("QRCAuthentication.html", window.location.href);
        authURL.searchParams.set("appId", window.__appId || "0");
        const verifyURL = authURL.toString();

        // 3. QR Code ko naye data ke saath banana
        const qrContainer = document.getElementById("qr-box");
        qrContainer.innerHTML = ""; // Purana QR hatane ke liye

        new QRCode(qrContainer, {
          text: verifyURL,
          width: 100,
          height: 100,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.H, // Higher level for overlay safety
        });
        const cross = document.createElement("div");
        cross.className = "qr-cross";
        cross.setAttribute("aria-hidden", "true");
        qrContainer.appendChild(cross);
      }

      function syncFieldsFrom(el) {
        const key = el.getAttribute("data-field");
        if (key) {
          const val = el.innerText;
          document.querySelectorAll(`[data-field="${key}"]`).forEach((node) => {
            if (node !== el) node.innerText = val;
          });
        }

        if (el.id === "certNo") {
          const digits = el.innerText.replace(/[^0-9]/g, "");
          const barcodeEl = document.getElementById("certNoBarcode");
          if (barcodeEl) barcodeEl.innerText = digits || el.innerText.trim();
          renderBarcode(digits || el.innerText.trim());
        }
      }

      function renderBarcode(value) {
        const svg = document.getElementById("barcodeSvg");
        if (!svg || !value || typeof JsBarcode === "undefined") return;
        JsBarcode(svg, value, {
          format: "CODE128",
          displayValue: false,
          height: 30,
          width: 1.0,
          margin: 0,
        });
      }

      document.addEventListener("input", (e) => {
        const el = e.target;
        if (el && el.classList && el.classList.contains("editable")) {
          syncFieldsFrom(el);
        }
      });

      // Jab aap PDF button dabayengi, pehle QR update hoga phir download
      async function savePDF() {
        const data = {
          certNo: document.getElementById("certNo").innerText.trim(),
          appNo: document.getElementById("appNo").innerText.trim(),
          date: document.getElementById("issueDate").innerText.trim(),
          name: document.getElementById("personName").innerText.trim(),
          father: document.getElementById("fatherName").innerText.trim(),
          village: document.getElementById("village").innerText.trim(),
          mouza: document.getElementById("mouza").innerText.trim(),
          circle: document.getElementById("circle").innerText.trim(),
          district: document.getElementById("district").innerText.trim(),
          income: document.getElementById("incomeSource").innerText.trim(),
          amount: document.getElementById("amount").innerText.trim(),
          words: document.getElementById("amountWords").innerText.trim(),
          cscName: document.getElementById("cscName").innerText.trim(),
          cscId: document.getElementById("cscId").innerText.trim(),
        };

        try {
          const res = await fetch("api/save.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          const out = await res.json();
          if (out && out.appId) {
            window.__appId = out.appId;
          }
        } catch (e) {
          // ignore, QR will show appId=0 if save fails
        }

        generateQR();
        setTimeout(async () => {
          const element = document.getElementById("certificate");
          const prevBodyPadding = document.body.style.padding;
          const prevBodyMargin = document.body.style.margin;
          const prevBodyDisplay = document.body.style.display;
          const prevBodyAlign = document.body.style.alignItems;
          const prevElemMargin = element.style.margin;
          const prevElemWidth = element.style.width;
          const prevElemHeight = element.style.height;
          document.body.style.padding = "0";
          document.body.style.margin = "0";
          document.body.style.display = "block";
          document.body.style.alignItems = "flex-start";
          element.style.margin = "0";
          element.style.width = "210mm";
          element.style.height = "297mm";
          try {
            const canvas = await html2canvas(element, {
              scale: 2,
              useCORS: true,
              allowTaint: true,
              backgroundColor: "#ffffff",
              scrollX: 0,
              scrollY: 0,
              windowWidth: element.offsetWidth,
              windowHeight: element.offsetHeight,
            });
            const imgData = canvas.toDataURL("image/jpeg", 0.98);
            const { jsPDF } = window.jspdf || {};
            const pdf = new jsPDF("p", "mm", "a4");
            pdf.addImage(imgData, "JPEG", 0, 0, 210, 297);
            pdf.save(
              "Certificate_" +
                document.getElementById("personName").innerText +
                ".pdf",
            );
          } finally {
            element.style.margin = prevElemMargin;
            element.style.width = prevElemWidth;
            element.style.height = prevElemHeight;
            document.body.style.padding = prevBodyPadding;
            document.body.style.margin = prevBodyMargin;
            document.body.style.display = prevBodyDisplay;
            document.body.style.alignItems = prevBodyAlign;
          }
        }, 500);
      }

      // Pehli baar page load hote hi QR bana de
      window.onload = () => {
        generateQR();
        const certEl = document.getElementById("certNo");
        if (certEl) syncFieldsFrom(certEl);
      };
    </script>
  </body>
</html>
